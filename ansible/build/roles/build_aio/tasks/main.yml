# Copyright (C) 2018 Freetech Solutions

# This file is part of OMniLeads

# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.

# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.

# You should have received a copy of the GNU General Public License
# along with this program.  If not, see http://www.gnu.org/licenses/.
---

- name: Configure yum for ansible
  ini_file: path=/etc/yum.conf section=main option="{{ item.option }}" no_extra_spaces=yes value="{{ item.value }}" state=present
  with_items:
    - { option: "sslverify", value: "0" }
    - { option: "timeout", value: "300" }
    - { option: "minrate", value: "100" }

# Se crean los directorios para el build
- name: Create build directories
  file: name={{ item }} state=directory recurse=yes owner=root group=root
  with_items:
    - "{{ asterisk_location }}"
    - "{{ kamailio_location }}"
    - "{{ virtualenv_location }}"

# Se generan los scripts de buildeo
- name: Generating build script
  template: src=templates/build_scripts/build_component.sh dest=/root mode=755

- name: Create /etc/systemd/system/ directory
  file: "dest=/etc/systemd/system/ state=directory recurse=yes"

# Se crean los scripts de systemd de cada servicio
- name: Generating systemd scripts
  template: src=templates/systemd/{{ item }} dest=/etc/systemd/system/
  with_items:
    - asterisk.service
    - kamailio.service
    - omnileads.service
    - redis.service
    - rtpengine.service

# Additional Kamailio files
- name: Creation of kamamailio run directories
  file: "path={{ item }} state=directory mode=0755"
  with_items:
      - "{{ kamailio_location }}/run/"
      - "{{ kamailio_location }}/run/kamailio/"

# Se cre el archivo kamailio en /etc/default este archivo contiene variables que va a usar systemctl para levantar kamailio
- name: Creation of kamailio file in /etc/default
  template: src=templates/systemd/kamailio.j2 dest=/etc/default/kamailio owner=root group=root mode=755

# Se ejecutan los scripts de build
- name: Execute build scripts
  shell: "{{ item }} chdir=/root"
  with_items:
    - "./build_component.sh --version={{ asterisk_version }} --component=asterisk"
    - "./build_component.sh --version={{ kamailio_version }} --component=kamailio"
    - "./build_component.sh --version={{ rtpengine_version }} --component=rtpengine"
    - "./build_component.sh --version={{ virtualenv_version }} --component=virtualenv"
